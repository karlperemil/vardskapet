var cvpHandlers={canvasClickHandler:null,videoTimeUpdateHandler:null,videoCanPlayHandler:null,windowResizeHandler:null},CanvasVideoPlayer=function(a){var b;this.options={framesPerSecond:25,hideVideo:!0,autoplay:!1,makeLoop:!1,pauseOnClick:!0,audio:!1,timelineSelector:!1,resetOnLastFrame:!0};for(b in a)this.options[b]=a[b];if(this.video=document.querySelector(this.options.videoSelector),this.canvas=document.querySelector(this.options.canvasSelector),this.timeline=document.querySelector(this.options.timelineSelector),this.timelinePassed=document.querySelector(this.options.timelineSelector+"> div"),!this.options.videoSelector||!this.video)return void console.error('No "videoSelector" property, or the element is not found');if(!this.options.canvasSelector||!this.canvas)return void console.error('No "canvasSelector" property, or the element is not found');if(this.options.timelineSelector&&!this.timeline)return void console.error('Element for the "timelineSelector" selector not found');if(this.options.timelineSelector&&!this.timelinePassed)return void console.error('Element for the "timelinePassed" not found');if(this.options.audio){if("string"==typeof this.options.audio){if(this.audio=document.querySelectorAll(this.options.audio)[0],!this.audio)return void console.error('Element for the "audio" not found')}else this.audio=document.createElement("audio"),this.audio.innerHTML=this.video.innerHTML,this.video.parentNode.insertBefore(this.audio,this.video),this.audio.load();/iPad|iPhone|iPod/.test(navigator.platform)&&(this.options.autoplay=!1)}this.ctx=this.canvas.getContext("2d"),this.playing=!1,this.resizeTimeoutReference=!1,this.RESIZE_TIMEOUT=1e3,this.init(),this.bind()};CanvasVideoPlayer.prototype.init=function(){this.video.load(),this.setCanvasSize(),this.options.hideVideo&&(this.video.style.display="none")},CanvasVideoPlayer.prototype.getOffset=function(a){var b,c,d;if(a)return c=a.getBoundingClientRect(),c.width||c.height||a.getClientRects().length?(d=a.ownerDocument,b=d.documentElement,{top:c.top+window.pageYOffset-b.clientTop,left:c.left+window.pageXOffset-b.clientLeft}):void 0},CanvasVideoPlayer.prototype.jumpTo=function(a){this.video.currentTime=this.video.duration*a,this.options.audio&&(this.audio.currentTime=this.audio.duration*a)},CanvasVideoPlayer.prototype.bind=function(){var a=this;!0===this.options.pauseOnClick&&this.canvas.addEventListener("click",cvpHandlers.canvasClickHandler=function(){a.playPause()}),this.video.addEventListener("timeupdate",cvpHandlers.videoTimeUpdateHandler=function(){a.drawFrame(),a.options.timelineSelector&&a.updateTimeline()}),this.video.addEventListener("canplay",cvpHandlers.videoCanPlayHandler=function(){a.drawFrame()}),this.video.readyState>=2&&a.drawFrame(),a.options.autoplay&&a.play(),a.options.timelineSelector&&this.timeline.addEventListener("click",function(b){var c=b.clientX-a.getOffset(a.canvas).left,d=c/a.timeline.offsetWidth;a.jumpTo(d)}),window.addEventListener("resize",cvpHandlers.windowResizeHandler=function(){clearTimeout(a.resizeTimeoutReference),a.resizeTimeoutReference=setTimeout(function(){a.setCanvasSize(),a.drawFrame()},a.RESIZE_TIMEOUT)}),this.unbind=function(){this.canvas.removeEventListener("click",cvpHandlers.canvasClickHandler),this.video.removeEventListener("timeupdate",cvpHandlers.videoTimeUpdateHandler),this.video.removeEventListener("canplay",cvpHandlers.videoCanPlayHandler),window.removeEventListener("resize",cvpHandlers.windowResizeHandler),this.options.audio&&this.audio.parentNode.removeChild(this.audio)}},CanvasVideoPlayer.prototype.updateTimeline=function(){var a=(100*this.video.currentTime/this.video.duration).toFixed(2);this.timelinePassed.style.width=a+"%"},CanvasVideoPlayer.prototype.setCanvasSize=function(){this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height)},CanvasVideoPlayer.prototype.play=function(){this.lastTime=Date.now(),this.playing=!0,this.loop(),this.options.audio&&(this.audio.currentTime=this.video.currentTime,this.audio.play())},CanvasVideoPlayer.prototype.pause=function(){this.playing=!1,this.options.audio&&this.audio.pause()},CanvasVideoPlayer.prototype.playPause=function(){this.playing?this.pause():this.play()},CanvasVideoPlayer.prototype.loop=function(){var a=this,b=Date.now(),c=(b-this.lastTime)/1e3;c>=1/this.options.framesPerSecond&&(this.video.currentTime=this.video.currentTime+c,this.lastTime=b,this.audio&&Math.abs(this.audio.currentTime-this.video.currentTime)>.3&&(this.audio.currentTime=this.video.currentTime)),this.video.currentTime>=this.video.duration&&(!1===this.options.makeLoop&&(this.playing=!1),!0===this.options.resetOnLastFrame&&(this.video.currentTime=0)),this.playing?this.animationFrame=requestAnimationFrame(function(){a.loop()}):cancelAnimationFrame(this.animationFrame)},CanvasVideoPlayer.prototype.drawFrame=function(){this.ctx.drawImage(this.video,0,0,this.width,this.height)};